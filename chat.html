<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Chat â€“ HazMiTarea</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-orange-50">

<div class="max-w-2xl mx-auto mt-6 bg-white rounded-2xl shadow p-5 border">
  <a href="index.html" class="text-sm text-orange-600">â† Volver</a>

  <h2 id="tituloTrabajo" class="text-2xl font-bold mt-2"></h2>

  <div id="mensajes" class="mt-4 h-80 overflow-y-auto p-3 border rounded-lg bg-gray-50">
    <!-- Mensajes aparecerÃ¡n aquÃ­ -->
  </div>

  <form id="formChat" class="mt-3 flex gap-2">
    <input id="msg" type="text" class="flex-1 border px-3 py-2 rounded-lg" placeholder="Escribe un mensaje..." required>
    <button class="bg-orange-600 text-white px-4 rounded-lg">Enviar</button>
  </form>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  addDoc,
  query,
  where,
  orderBy,
  onSnapshot,
  serverTimestamp,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// ConfiguraciÃ³n de Firebase (tuya)
const firebaseConfig = {
  apiKey: "AIzaSyBlsVCnScpWppXMQLvAtu54XS_2rxj84Eo",
  authDomain: "hazmitarea01-ab6c6.firebaseapp.com",
  projectId: "hazmitarea01-ab6c6",
  storageBucket: "hazmitarea01-ab6c6.appspot.com",
  messagingSenderId: "771122045443",
  appId: "1:771122045443:web:86ebc251ab550466b46436"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM
const tituloTrabajoEl = document.getElementById("tituloTrabajo");
const mensajesEl = document.getElementById("mensajes");
const formChat = document.getElementById("formChat");
const msgInput = document.getElementById("msg");

// Obtener ID de trabajo
const params = new URLSearchParams(window.location.search);
const jobId = params.get("job");

let currentUser;
let ownerUid;

// Cargar datos del trabajo
async function cargarTrabajo() {
  const snap = await getDoc(doc(db, "jobs", jobId));
  if (!snap.exists()) {
    tituloTrabajoEl.textContent = "Trabajo no encontrado";
    return;
  }
  tituloTrabajoEl.textContent = snap.data().titulo;
  ownerUid = snap.data().ownerUid;
}

// Iniciar chat
function iniciarChat(user) {
  currentUser = user;

  // ID Ãºnico de chat
  const chatId = `${jobId}_${user.uid}`;

  // Consulta de mensajes
  const mensajesQuery = query(
    collection(db, "messages"),
    where("chatId", "==", chatId),
    orderBy("fecha", "asc")
  );

  onSnapshot(mensajesQuery, (snapshot) => {
    mensajesEl.innerHTML = "";
    snapshot.forEach((docu) => {
      const m = docu.data();
      const mine = m.uid === user.uid;
      mensajesEl.innerHTML += `
        <div class="${mine ? "text-right" : "text-left"}">
          <span class="inline-block px-3 py-2 rounded-lg ${mine ? "bg-orange-200" : "bg-gray-200"}">
            ${m.texto}
          </span>
        </div>
      `;
    });
    mensajesEl.scrollTop = mensajesEl.scrollHeight;
  });

  formChat.addEventListener("submit", async (e) => {
  e.preventDefault();

  const texto = msgInput.value.trim();
  if (!texto) return;

  console.log("ğŸ“¨ Enviando mensaje:", texto);

  await addDoc(collection(db, "messages"), {
    chatId,
    jobId,
    uid: user.uid,
    texto,
    fecha: serverTimestamp()
  });

  await setDoc(doc(db, "userChats", chatId), {
    chatId,
    jobId,
    users: [user.uid, ownerUid],
    lastMessage: texto,
    updatedAt: serverTimestamp()
  }, { merge: true });

  msgInput.value = "";
});


    // Actualizar resumen de chat
    await setDoc(doc(db, "userChats", chatId), {
      chatId,
      jobId,
      users: [user.uid, ownerUid],
      lastMessage: texto,
      updatedAt: serverTimestamp()
    }, { merge: true });

    msgInput.value = "";
  };
}

// AutenticaciÃ³n
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("Debes iniciar sesiÃ³n para chatear.");
    window.location.href = "index.html";
    return;
  }

  await cargarTrabajo();
  iniciarChat(user);
});
</script>



</body>
</html>
