<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Chat â€“ HazMiTarea</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-orange-50">

<div class="max-w-2xl mx-auto mt-6 bg-white rounded-2xl shadow p-5 border">
  <a href="index.html" class="text-sm text-orange-600">â† Volver</a>

  <h2 id="tituloTrabajo" class="text-2xl font-bold mt-2"></h2>

  <div id="mensajes" class="mt-4 h-80 overflow-y-auto p-3 border rounded-lg bg-gray-50">
    <!-- Mensajes aparecerÃ¡n aquÃ­ -->
  </div>

  <form id="formChat" class="mt-3 flex gap-2">
    <input id="msg" type="text" class="flex-1 border px-3 py-2 rounded-lg" placeholder="Escribe un mensaje..." required>
    <button class="bg-orange-600 text-white px-4 rounded-lg">Enviar</button>
  </form>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot,
  serverTimestamp,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

/* ğŸ”§ Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBlsVCnScpWppXMQLvAtu54XS_2rxj84Eo",
  authDomain: "hazmitarea01-ab6c6.firebaseapp.com",
  projectId: "hazmitarea01-ab6c6",
  storageBucket: "hazmitarea01-ab6c6.appspot.com",
  messagingSenderId: "771122045443",
  appId: "1:771122045443:web:86ebc251ab550466b46436"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ğŸ§  DOM */
const params = new URLSearchParams(window.location.search);
const jobId = params.get("job");

const tituloEl = document.getElementById("tituloTrabajo");
const mensajesEl = document.getElementById("mensajes");
const formChat = document.getElementById("formChat");
const msgInput = document.getElementById("msg");

let ownerUid = null;

/* ğŸ“Œ Cargar trabajo */
async function cargarTrabajo() {
  const snap = await getDoc(doc(db, "jobs", jobId));
  if (!snap.exists()) {
    tituloEl.textContent = "Trabajo no encontrado";
    return;
  }
  tituloEl.textContent = snap.data().titulo;
  ownerUid = snap.data().ownerUid;
}

/* ğŸ’¬ Iniciar chat */
function iniciarChat(userUid) {
 const chatId = jobId;


  const chatRef = doc(db, "jobs", jobId, "chats", chatId);
  const mensajesRef = collection(chatRef, "mensajes");

  setDoc(chatRef, {
    jobId,
    participants: [userUid, ownerUid],
    updatedAt: serverTimestamp()
  }, { merge: true });

  const q = query(mensajesRef, orderBy("fecha"));

  onSnapshot(q, snap => {
    mensajesEl.innerHTML = "";
    snap.forEach(d => {
      const m = d.data();
      const align = m.uid === userUid ? "text-right" : "text-left";
      const bg = m.uid === userUid ? "bg-orange-200" : "bg-gray-200";

      mensajesEl.innerHTML += `
        <div class="${align}">
          <span class="inline-block px-3 py-2 rounded-lg ${bg} mt-1">
            ${m.texto}
          </span>
        </div>`;
    });
    mensajesEl.scrollTop = mensajesEl.scrollHeight;
  });

  formChat.onsubmit = async (e) => {
  e.preventDefault();

  const texto = msgInput.value.trim();
  if (!texto) return;

  // 1ï¸âƒ£ Guardar mensaje
  await addDoc(mensajesRef, {
    texto,
    uid: userUid,
    fecha: serverTimestamp()
  });

  // 2ï¸âƒ£ Guardar resumen del chat PARA AMBOS
  const resumenChat = {
    jobId: jobId,
    chatId: chatId,
    participants: [userUid, ownerUid],
    lastMessage: texto,
    updatedAt: serverTimestamp()
  };

  // Para quien envÃ­a
  await setDoc(
    doc(db, "userChats", `${userUid}_${chatId}`),
    resumenChat,
    { merge: true }
  );

  // Para el dueÃ±o del trabajo (receptor)
  await setDoc(
    doc(db, "userChats", `${ownerUid}_${chatId}`),
    resumenChat,
    { merge: true }
  );

  msgInput.value = "";
};


}

/* ğŸ” Auth */
onAuthStateChanged(auth, user => {
  if (!user) {
    alert("Debes iniciar sesiÃ³n");
    window.location.href = "index.html";
    return;
  }
  cargarTrabajo().then(() => iniciarChat(user.uid));
});
</script>

</body>
</html>
