<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Chat – HazMiTarea</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-orange-50">

<div class="max-w-2xl mx-auto mt-6 bg-white rounded-2xl shadow p-5 border">
  <a href="index.html" class="text-sm text-orange-600">← Volver</a>

  <h2 id="tituloTrabajo" class="text-2xl font-bold mt-2"></h2>

  <div id="mensajes" class="mt-4 h-80 overflow-y-auto p-3 border rounded-lg bg-gray-50">
    <!-- Mensajes aparecerán aquí -->
  </div>

  <form id="formChat" class="mt-3 flex gap-2">
    <input id="msg" type="text" class="flex-1 border px-3 py-2 rounded-lg" placeholder="Escribe un mensaje..." required>
    <button class="bg-orange-600 text-white px-4 rounded-lg">Enviar</button>
  </form>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // Configuración Firebase (tuya)
  const firebaseConfig = {
    apiKey: "AIzaSyBlsVCnScpWppXMQLvAtu54XS_2rxj84Eo",
    authDomain: "hazmitarea01-ab6c6.firebaseapp.com",
    projectId: "hazmitarea01-ab6c6",
    storageBucket: "hazmitarea01-ab6c6.appspot.com",
    messagingSenderId: "771122045443",
    appId: "1:771122045443:web:86ebc251ab550466b46436"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Obtener ID del trabajo desde la URL
  const params = new URLSearchParams(window.location.search);
 const jobId = params.get("job");

  const tituloTrabajoEl = document.getElementById("tituloTrabajo");
  const mensajesEl = document.getElementById("mensajes");
  const formChat = document.getElementById("formChat");
  const msgInput = document.getElementById("msg");

  // Cargar datos del trabajo
  async function cargarTrabajo() {
    const ref = doc(db, "jobs", jobId);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      tituloTrabajoEl.textContent = "Trabajo no encontrado";
      return;
    }

    tituloTrabajoEl.textContent = snap.data().titulo;
    window.ownerUid = snap.data().ownerUid;

  }

  // Chat en tiempo real
 function iniciarChat(uid) {
  const ownerUid = window.ownerUid;

  // Crear ID único del chat
  const chatId = uid < ownerUid ? `${uid}_${ownerUid}` : `${ownerUid}_${uid}`;

  const mensajesRef = collection(db, "jobs", jobId, "chats", chatId, "mensajes");
  const q = query(mensajesRef, orderBy("fecha", "asc"));

   import { setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const chatRef = doc(db, "jobs", jobId, "chats", chatId);

// crear el chat si no existe
await setDoc(chatRef, {
  jobId: jobId,
  participants: [uid, ownerUid],
  updatedAt: serverTimestamp()
}, { merge: true });


  // escuchar mensajes
  onSnapshot(q, (snap) => {
    mensajesEl.innerHTML = "";

    snap.forEach(docu => {
      const m = docu.data();
      const alineacion = m.uid === uid ? "text-right" : "text-left";
      const color = m.uid === uid ? "bg-orange-200" : "bg-gray-200";

      mensajesEl.innerHTML += `
        <div class="${alineacion}">
          <span class="inline-block px-3 py-2 rounded-lg ${color} mt-1">${m.texto}</span>
        </div>
      `;
    });

    mensajesEl.scrollTop = mensajesEl.scrollHeight;
  });

  // Enviar mensajes
  formChat.addEventListener("submit", async (e) => {
    e.preventDefault();

    await addDoc(mensajesRef, {
      texto: msgInput.value,
      uid: uid,
      fecha: serverTimestamp()
    });

    msgInput.value = "";
  });
}

  // Detectar si usuario está logueado
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      alert("Debes iniciar sesión para usar el chat.");
      window.location.href = "index.html";
      return;
    }

    iniciarChat(user.uid);
  });

  cargarTrabajo();
</script>

</body>
</html>
